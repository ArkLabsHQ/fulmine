services:
  pgnbxplorer:
    restart: unless-stopped
    image: postgres:16
    container_name: pgnbxplorer
    ports:
      - 5432:5432
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - type: tmpfs
        target: /var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U postgres -d nbxplorer -h 127.0.0.1 -p 5432",
        ]
      interval: 2s
      timeout: 2s
      retries: 30
  nbxplorer:
    restart: unless-stopped
    container_name: nbxplorer
    ports:
      - 32838:32838
    image: nicolasdorier/nbxplorer:2.5.30
    environment:
      - NBXPLORER_NETWORK=regtest
      - NBXPLORER_CHAINS=btc
      - NBXPLORER_BTCRPCURL=http://bitcoin:18443
      - NBXPLORER_BTCNODEENDPOINT=bitcoin:18444
      - NBXPLORER_BTCRPCUSER=admin1
      - NBXPLORER_BTCRPCPASSWORD=123
      - NBXPLORER_VERBOSE=1
      - NBXPLORER_BIND=0.0.0.0:32838
      - NBXPLORER_TRIMEVENTS=10000
      - NBXPLORER_SIGNALFILESDIR=/datadir
      - NBXPLORER_POSTGRES=User ID=postgres;Host=pgnbxplorer;Port=5432;Application Name=nbxplorer;MaxPoolSize=20;Database=nbxplorer
      - NBXPLORER_EXPOSERPC=1
      - NBXPLORER_NOAUTH=1
    volumes:
      - type: tmpfs
        target: /datadir
    depends_on:
      pgnbxplorer:
        condition: service_healthy
  arkd-wallet:
    restart: unless-stopped
    build:
      context: .
      dockerfile: arkdwallet.Dockerfile
    container_name: arkd-wallet
    depends_on:
      - nbxplorer
    ports:
      - "6060:6060"
    environment:
      - ARKD_WALLET_LOG_LEVEL=5
      - ARKD_WALLET_NBXPLORER_URL=http://nbxplorer:32838
      - ARKD_WALLET_NETWORK=regtest
      - ARKD_WALLET_SIGNER_KEY=1822f98b3a7366532d3a875fa94c97948fe8f6a71a0ca1e94587be5f4ce646d1
    volumes:
      - type: tmpfs
        target: /app/data
  arkd:
    build:
      context: .
      dockerfile: arkd.Dockerfile
    container_name: arkd
    restart: unless-stopped
    depends_on:
      - arkd-wallet
    ports:
      - "7071:7071"
      - "7070:7070"
      - "7071:7071"
    environment:
      - ARKD_LOG_LEVEL=6
      - ARKD_NO_MACAROONS=true
      - ARKD_VTXO_TREE_EXPIRY=512
      - ARKD_UNILATERAL_EXIT_DELAY=512
      - ARKD_PUBLIC_UNILATERAL_EXIT_DELAY=512
      - ARKD_BOARDING_EXIT_DELAY=2048
      - ARKD_CHECKPOINT_EXIT_DELAY=10
      - ARKD_WALLET_ADDR=arkd-wallet:6060
      - ARKD_ESPLORA_URL=http://chopsticks:3000
      - ARKD_VTXO_MIN_AMOUNT=1
      - ARKD_LIVE_STORE_TYPE=inmemory
      - ARKD_EVENT_DB_TYPE=badger
      - ARKD_DB_TYPE=sqlite
      - ARKD_SESSION_DURATION=30
    volumes:
      - type: tmpfs
        target: /app/data

  fulmine:
    container_name: fulmine
    depends_on:
      - arkd
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - FULMINE_ARK_SERVER=arkd:7070
      - FULMINE_ESPLORA_URL=http://chopsticks:3000
      - FULMINE_BOLTZ_URL=http://boltz:9001
      - FULMINE_BOLTZ_WS_URL=ws://boltz:9004
      - FULMINE_NO_MACAROONS=true
      - FULMINE_LOG_LEVEL=5
      - FULMINE_DISABLE_TELEMETRY=true
      - FULMINE_SWAP_TIMEOUT=120
      - FULMINE_SCHEDULER_POLL_INTERVAL=10
      - FULMINE_DELEGATOR_ENABLED=true
    ports:
      - "7000:7000"
      - "7001:7001"
      - "7004:7002"
    volumes:
      - fulmine_data:/app/data

  mock-boltz:
    build:
      context: .
      dockerfile: mockboltz.Dockerfile
    container_name: mock-boltz
    restart: unless-stopped
    depends_on:
      - arkd
    ports:
      - "9101:9001"
    environment:
      - MOCK_BOLTZ_LISTEN_ADDR=:9001
      - MOCK_BOLTZ_ARKD_URL=http://arkd:7070
      - MOCK_BOLTZ_ARK_HRP=tark
      - MOCK_BOLTZ_NETWORK=regtest
      - MOCK_BOLTZ_LOG_LEVEL=debug
      - MOCK_BOLTZ_ARK_REFUND_LOCKTIME_SECONDS=60
      - MOCK_BOLTZ_BTC_LOCKUP_TIMEOUT_BLOCKS=720
      - MOCK_BOLTZ_UNILATERAL_CLAIM_DELAY=512
      - MOCK_BOLTZ_UNILATERAL_REFUND_DELAY=512
      - MOCK_BOLTZ_UNILATERAL_REFUND_NO_RECV_DELAY=1024
      - MOCK_BOLTZ_SERVICE_FEE_PPM=20000
      - MOCK_BOLTZ_MINER_FEE_SAT=200

  fulmine-mock:
    container_name: fulmine-mock
    depends_on:
      - arkd
      - mock-boltz
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - FULMINE_ARK_SERVER=arkd:7070
      - FULMINE_ESPLORA_URL=http://chopsticks:3000
      - FULMINE_BOLTZ_URL=http://mock-boltz:9001
      - FULMINE_BOLTZ_WS_URL=ws://mock-boltz:9001
      - FULMINE_NO_MACAROONS=true
      - FULMINE_LOG_LEVEL=5
      - FULMINE_DISABLE_TELEMETRY=true
      - FULMINE_SWAP_TIMEOUT=120
      - FULMINE_SCHEDULER_POLL_INTERVAL=10
    ports:
      - "7100:7000"
      - "7101:7001"
    volumes:
      - fulmine_mock_data:/app/data

  boltz-cln:
    build:
      context: .
      dockerfile: cln.Dockerfile
    restart: unless-stopped
    container_name: boltz-cln
    healthcheck:
      test: ["CMD", "lightning-cli", "--network=regtest", "getinfo"]
      interval: 10s
      timeout: 5s
      retries: 10
    command:
      - --bind-addr=0.0.0.0:9735
      - --bitcoin-rpcconnect=bitcoin:18443
      - --bitcoin-rpcpassword=123
      - --bitcoin-rpcuser=admin1
      - --log-level=debug
      - --network=regtest
      - --large-channels
      - --grpc-host=0.0.0.0
      - --grpc-port=9736
      - --plugin=/root/hold
      - --plugin=/root/clnurl
      - --ignore-fee-limits=false
      - --min-emergency-msat=1000000
    volumes:
      - cln_datadir:/root/.lightning/regtest
  boltz-lnd:
    image: lightninglabs/lnd:v0.19.1-beta
    restart: unless-stopped
    container_name: boltz-lnd
    healthcheck:
      test:
        [
          "CMD",
          "lncli",
          "--rpcserver=localhost:10009",
          "--macaroonpath=/root/.lnd/data/chain/bitcoin/regtest/admin.macaroon",
          "--tlscertpath=/root/.lnd/tls.cert",
          "getinfo",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    command:
      - "--bitcoin.regtest"
      - "--bitcoin.node=bitcoind"
      - "--maxpendingchannels=10"
      - "--rpclisten=0.0.0.0:10009"
      - "--bitcoind.rpchost=bitcoin:18443"
      - "--bitcoind.rpcuser=admin1"
      - "--bitcoind.rpcpass=123"
      - "--bitcoind.zmqpubrawblock=tcp://bitcoin:28332"
      - "--bitcoind.zmqpubrawtx=tcp://bitcoin:28333"
      - "--db.bolt.auto-compact"
      - "--db.prune-revocation"
      - "--alias=Ark Labs"
      - "--tlsextradomain=boltz-lnd"
      - "--protocol.option-scid-alias"
      - "--protocol.wumbo-channels"
      - "--accept-keysend"
      - "--minchansize=25000"
      - "--noseedbackup"
      - "--gc-canceled-invoices-on-startup"
      - "--coin-selection-strategy=random"
      - "--protocol.custom-message=513"
      - "--protocol.custom-nodeann=39"
      - "--protocol.custom-init=39"
      - "--no-rest-tls"
      - "--restcors=*"
    volumes:
      - lnd_datadir:/root/.lnd
    ports:
      - "9736:9735"
      - "10010:10009"
  boltz:
    restart: unless-stopped
    image: boltz/boltz:latest
    container_name: boltz
    ports:
      - "9000:9000"
      - "9001:9001"
      - "9004:9004"
      - "9005:9005"
    expose:
      - "9001"
      - "9004"
      - "9005"
    depends_on:
      boltz-postgres:
        condition: service_healthy
      boltz-fulmine:
        condition: service_started
      boltz-lnd:
        condition: service_healthy
      boltz-cln:
        condition: service_healthy
    environment:
      BOLTZ_CONFIG: |
        loglevel = "debug"
        network = "regtest"
        [ark]
        host = "boltz-fulmine"
        port = 7000
        useLocktimeSeconds = true
        [ark.unilateralDelays]
        claim = 10 # 10 mins
        refund = 10 # 10 mins
        refundWithoutReceiver = 20 # 20 mins

        [api]
        host = "0.0.0.0"
        port = 9001
        cors = "*"

        [grpc]
        host = "0.0.0.0"
        port = 9000

        [sidecar]
        [sidecar.grpc]
        host = "0.0.0.0"
        port = 9003

        [sidecar.ws]
        host = "0.0.0.0"
        port = 9004

        [sidecar.api]
        host = "0.0.0.0"
        port = 9005

        [postgres]
        host = "boltz-postgres"
        port = 5432
        database = "boltz"
        username = "postgres"
        password = "postgres"

        [swap]
        deferredClaimSymbols = [ "BTC" ]

        [[pairs]]
        base = "ARK"
        quote = "BTC"
        rate = 1
        fee = 0.4
        swapInFee = 0.01
        invoiceExpiry = 361
        maxSwapAmount = 4294967
        minSwapAmount = 1000

        [pairs.timeoutDelta]
        reverse = 1440
        chain=1440
        swapMinimal = 1440
        swapMaximal = 2880
        swapTaproot = 2880

        [[currencies]]
        symbol = "BTC"
        network = "bitcoinRegtest"
        minWalletBalance = 10000000
        minLocalBalance = 10000000
        minRemoteBalance = 10000000
        maxSwapAmount = 4294967
        minSwapAmount = 50000
        maxZeroConfAmount = 100000
        preferredWallet = "core"

        [currencies.chain]
        host = "bitcoin"
        port = 18443
        user = "admin1"
        password = "123"

        [currencies.lnd]
        host = "boltz-lnd"
        port = 10009
        certpath = "/home/boltz/.lnd/tls.cert"
        macaroonpath = "/home/boltz/.lnd/data/chain/bitcoin/regtest/admin.macaroon"

        [currencies.cln]
        host = "boltz-cln"
        port = 9736
        rootCertPath = "/home/boltz/.cln/ca.pem"
        privateKeyPath = "/home/boltz/.cln/client-key.pem"
        certChainPath = "/home/boltz/.cln/client.pem"

        [currencies.cln.hold]
        host = "boltz-cln"
        port = 9292
        rootCertPath = "/home/boltz/.cln/hold/ca.pem"
        privateKeyPath = "/home/boltz/.cln/hold/client-key.pem"
        certChainPath = "/home/boltz/.cln/hold/client.pem"

        [nodeSwitch]
        clnAmountThreshold = 1000
    volumes:
      - boltz_datadir:/home/boltz/.boltz
      - lnd_datadir:/home/boltz/.lnd
      - cln_datadir:/home/boltz/.cln
    entrypoint: sh -c 'echo "$$BOLTZ_CONFIG" > /home/boltz/.boltz/boltz.config && boltzd --datadir /home/boltz/.boltz --configpath /home/boltz/.boltz/boltz.config'
  boltz-postgres:
    image: postgres:15.4
    restart: unless-stopped
    container_name: boltz-postgres
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 3s
      retries: 5
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: boltz
      POSTGRES_HOST_AUTH_METHOD: trust
    expose:
      - "5432"
    volumes:
      - postgres_datadir:/var/lib/postgresql/data
  boltz-fulmine:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    container_name: boltz-fulmine
    # healthcheck:
    #   test: ["CMD-SHELL", "curl -s http://localhost:7001/api/v1/info | jq -e '((.code // 0) == 0)'"]
    #   interval: 30s
    #   timeout: 3s
    #   retries: 30
    environment:
      - FULMINE_ARK_SERVER=http://arkd:7070
      - FULMINE_ESPLORA_URL=http://chopsticks:3000
      - FULMINE_NO_MACAROONS=true
      - FULMINE_LOG_LEVEL=5
      - FULMINE_DISABLE_TELEMETRY=true
      - FULMINE_SCHEDULER_POLL_INTERVAL=10
    ports:
      - 7002:7000
      - 7003:7001
    volumes:
      - bitcoin_fulmine_data:/app/data

volumes:
  postgres_datadir:
    name: postgres_datadir
  boltz_datadir:
    name: boltz_datadir
  bitcoin_fulmine_data:
    name: bitcoin_fulmine_data
  fulmine_data:
    name: fulmine_data
  fulmine_mock_data:
    name: fulmine_mock_data
  lnd_datadir:
    name: lnd_datadir
  cln_datadir:
    name: cln_datadir

networks:
  default:
    name: nigiri
    external: true
